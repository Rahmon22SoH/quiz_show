# Система логирования бизнес-событий

## Общая концепция

В проекте реализована **централизованная система логирования бизнес-событий**.  
Все ключевые действия пользователей и администраторов, а также важные события бизнес-логики (например, участие в квизе, изменение профиля, пополнение баланса, завершение квиза и т.д.) логируются в базу данных в таблицу `Log`.

Это позволяет:
- Вести аудит действий пользователей и админов.
- Анализировать поведение пользователей и выявлять аномалии.
- Упрощать отладку и расследование инцидентов.
- Стандартизировать подход к логированию по всему проекту.

---

## Основные компоненты

### Модель Log

Вся информация о событиях сохраняется в таблицу `Log`.  
Типичные поля:
- `user_id` — ID пользователя, совершившего действие (если применимо)
- `action` — короткое название события (англ., snake_case)
- `details` — строка с параметрами события (user_id, ip, quiz_id и т.д.)
- `level` — уровень события (INFO, WARNING, ERROR)
- `message` — пояснение на русском языке
- `module`, `function`, `line` — для технической детализации

### Централизованный логгер

Вся бизнес-логика логируется через функцию:
python
from app.utils.logger import log_event, make_details
log_event(
action="название_события",
user_id=...,
details=make_details(...),
level="INFO" | "WARNING" | "ERROR",
message="Пояснение на русском",
module=name,
function="имя_функции"
)

### Формирование details

Для стандартизации используется функция-хелпер:


python
details = make_details(user_id=..., ip=..., quiz_id=..., ...)


---

## Где и как используется логирование

### Модуль профиля (`app/profile/views.py`)
- **Изменение профиля:**  
  Логируется событие `profile_updated` с деталями о пользователе и изменённых полях.
- **Пополнение баланса:**  
  Событие `balance_deposit` с деталями о сумме и пользователе.

### Модуль квизов (`app/quiz/views.py`)
- **Участие в квизе:**  
  Событие `quiz_joined` с деталями о пользователе и квизе.
- **Неудачная попытка:**  
  Событие `quiz_join_failed` с причиной.
- **Завершение квиза:**  
  Событие `quiz_finished` (например, из Celery-задачи).

### Модуль админки (`app/admin/views.py`)
- **Блокировка/разблокировка пользователя:**  
  Событие `admin_blocked_user` с деталями о действии.
- **Ручное завершение квиза:**  
  Событие `admin_finished_quiz`.

### Celery-задачи (`app/celery/tasks.py`)
- **Автоматическое завершение квиза:**  
  Событие `quiz_finished` с деталями о квизе и владельце.

### Обработка ошибок (`app/utils/error_handlers.py`)
- Все ошибки логируются в файл и (по желанию) в таблицу Log через `log_event`.

---

## Пример использования
python
log_event(
action="quiz_joined",
user_id=current_user.id,
details=make_details(user_id=current_user.id, quiz_id=quiz_id, ip=request.remote_addr),
level="INFO",
message="Пользователь присоединился к квизу",
module=name,
function="join_quiz"
)


---

## Преимущества подхода

- **Стандартизация:** Все логи в едином формате, легко анализировать.
- **Гибкость:** Можно быстро добавить логирование в любой модуль.
- **Безопасность:** В логах фиксируются ключевые параметры (user_id, ip и т.д.).
- **Масштабируемость:** Легко расширять под новые бизнес-события.

---

## Как добавить логирование нового события

1. Импортируй функции:
   ```python
   from app.utils.logger import log_event, make_details
   ```
2. В нужном месте вызови:
   ```python
   log_event(
       action="название_события",
       user_id=...,
       details=make_details(...),
       level="INFO",
       message="Пояснение на русском",
       module=__name__,
       function="имя_функции"
   )
   ```

---

## Примечания

- Старые способы логирования (`log_action`, прямое создание Log, print для бизнес-событий) **не используются**.
- Email-уведомления и связанные с ними логи полностью удалены.
- Все логи ошибок по-прежнему пишутся в файл через стандартный Python-логгер.

---